# Proposal: enhance-selection-popup

## Summary

扩展选中文字弹框功能，从单一的「添加到需记忆」按钮升级为功能丰富的工具栏卡片，支持翻译、发音、复制等常用操作。

## Motivation

当前选中文字后只能添加到记忆列表，功能单一。用户在阅读时经常需要：
- 快速翻译不认识的词汇或句子
- 朗读发音以加深记忆
- 复制文本用于其他用途

扩展弹框功能可以显著提升学习效率和用户体验。

## Scope

### In Scope
- 重构 selectionPopup 为两阶段卡片式 UI
- 按文本长度区分工具栏按钮（1-50/50-300/>300）
- 实现混合翻译策略（有道 + AI）
- 翻译结果展示（含词典、音标、发音）
- 句子翻译结果中原文词汇可点击添加到记忆
- 主题适配（dark/light）

### Out of Scope
- 网页搜索功能（低优先级，后续迭代）
- 翻译历史记录
- 自定义工具栏按钮

## Solution Overview

### UI 设计

**工具栏（按文本长度区分）**

短文本（1-50 字符）：
```
┌───────────────────────────┐
│  🔄 翻译  ❤️ 记忆  📋 复制  │
└───────────────────────────┘
```

段落文本（50-300 字符）：
```
┌─────────────────┐
│  🔄 翻译  📋 复制 │
└─────────────────┘
```

超长文本（>300 字符）：不响应

**翻译结果展开（单词）**
```
┌───────────────────────────┐
│  🔄 翻译  ❤️ 记忆  📋 复制  │
├───────────────────────────┤
│  example                B1│
│  🔊 /ɪɡˈzæmpəl/           │
│  原文: 例子                │
│  n. 例子，实例             │
└───────────────────────────┘
```

**翻译结果展开（句子，原文词汇可点击）**
```
┌─────────────────────────────────┐
│  🔄 翻译  📋 复制                 │
├─────────────────────────────────┤
│  译文: 这是一个复杂的例子          │
│  🔊 发音                         │
│  原文: This is a [complicated]   │
│        [example]                 │
│        ↑ 点击词汇可添加到记忆      │
└─────────────────────────────────┘
```

### 翻译策略

采用混合策略优化速度和成本：

| 条件 | 翻译服务 | 原因 |
|------|----------|------|
| 短文本（≤10词）+ 中英互译 | 有道 API | 快速、免费 |
| 长文本 或 非中英语言 | AI (LLM) | 质量高、多语言 |

### 技术方案

1. **UI 组件**：扩展 `createSelectionPopup()` 支持多状态渲染
2. **翻译服务**：新增 `translateText()` 函数封装混合策略
3. **事件处理**：在 `event-handlers.js` 添加新按钮事件
4. **样式**：复用 tooltip 样式变量，新增工具栏样式

## Impact

- **用户体验**：选中文字后可快速翻译、发音，学习效率提升
- **代码改动**：中等规模，主要涉及 UI 组件和事件处理
- **兼容性**：保持现有功能不变，纯增量扩展

## Risks & Mitigations

| 风险 | 缓解措施 |
|------|----------|
| 有道 API 调用限制 | 错误处理 + 自动降级到 AI |
| 长文本翻译超时 | Loading 状态 + 超时取消 |
| 弹框遮挡内容 | 智能定位 + 可拖拽（后续） |

## Related Specs

- `selection-toolbar` - 新增能力规格

## Status

- [x] Proposal drafted
- [x] Design reviewed
- [x] Tasks defined
- [ ] Approved for implementation
