# Tasks: enhance-selection-popup

## Overview

实现选中文字弹框扩展功能，根据文本长度提供不同操作，支持翻译、记忆、复制，翻译结果支持发音和词汇点击添加记忆。

## Task List

### Phase 1: 基础架构

- [ ] **T1.1** 重构 `createSelectionPopup()` 函数
  - 支持多状态渲染（idle/loading/result/error）
  - 支持文本长度类型（short/paragraph）
  - 创建工具栏 DOM 结构
  - 添加 `data-state` 和 `data-length` 属性
  - 验证：弹框正确显示对应按钮

- [ ] **T1.2** 添加工具栏 CSS 样式
  - 工具栏按钮布局（flex 横向排列）
  - 按钮 hover/active 状态
  - 主题适配（dark/light）
  - 验证：样式与现有 tooltip 风格一致

### Phase 2: 翻译服务

- [ ] **T2.1** 实现有道翻译 API 调用
  - 新增 `translateWithYoudao(text, from, to)` 函数
  - 通过 background script 代理请求
  - 错误处理和超时控制
  - 验证：中英短文本翻译正确返回

- [ ] **T2.2** 实现 AI 翻译调用
  - 新增 `translateWithAI(text, targetLang)` 函数
  - 复用现有 LLM 调用逻辑
  - 构造翻译专用 prompt
  - 验证：长文本和非中英语言翻译正确

- [ ] **T2.3** 实现混合翻译策略
  - 新增 `translateText(text)` 统一入口
  - 实现策略选择逻辑
  - 有道失败自动降级到 AI
  - 验证：不同场景正确选择翻译服务

### Phase 3: 功能实现

- [ ] **T3.1** 实现翻译按钮功能
  - 点击触发翻译
  - 显示 loading 状态
  - 展开结果区域
  - 验证：翻译流程完整可用

- [ ] **T3.2** 实现单词翻译结果展示
  - 翻译文本显示
  - 音标显示
  - 发音按钮
  - 词典释义加载
  - 验证：单词结果区域正确渲染

- [ ] **T3.3** 实现句子翻译结果展示
  - 译文显示
  - 发音按钮
  - 原文分词显示
  - 验证：句子结果区域正确渲染

- [x] **T3.4** 实现句子词汇点击功能
  - 分词处理（tokenizeText）
  - 虚词过滤（isMemorizableWord）
  - 点击显示「添加到记忆」按钮
  - 添加到记忆列表
  - 验证：词汇点击交互正常

- [ ] **T3.5** 实现记忆按钮功能（工具栏）
  - 复用现有 `addToMemorizeList()` 逻辑
  - 按钮状态切换（已添加/未添加）
  - 验证：添加到记忆列表成功

- [ ] **T3.6** 实现复制按钮功能
  - 复制选中文本到剪贴板
  - 显示复制成功提示
  - 验证：复制功能正常

### Phase 4: 事件处理

- [ ] **T4.1** 重构选中文本事件处理
  - 更新 mouseup 事件处理逻辑
  - 根据文本长度判断显示哪些按钮
  - 超过 300 字符不响应
  - 支持弹框状态重置
  - 点击弹框外部关闭
  - 验证：交互流程顺畅

- [ ] **T4.2** 添加工具栏按钮事件监听
  - 翻译/记忆/复制按钮点击
  - 事件委托到 selectionPopup
  - 验证：所有按钮响应正确

- [x] **T4.3** 添加词汇点击事件监听
  - 句子原文词汇点击
  - 显示/隐藏「添加到记忆」弹出
  - 验证：词汇点击交互正确

### Phase 5: 优化与测试

- [ ] **T5.1** 添加翻译缓存
  - 内存缓存翻译结果
  - 相同文本不重复请求
  - 验证：缓存命中正常

- [ ] **T5.2** 错误处理完善
  - 网络错误提示
  - API 配置缺失提示
  - 重试机制
  - 验证：各种错误场景处理正确

- [ ] **T5.3** 集成测试
  - 短文本（1-50字符）完整工具栏
  - 段落文本（50-300字符）精简工具栏
  - 超长文本（>300字符）不响应
  - 单词翻译结果展示
  - 句子翻译结果展示
  - 句子词汇点击添加记忆
  - 主题切换
  - 验证：所有功能正常工作

## Dependencies

```
T1.1 ──▶ T1.2 ──▶ T4.1
              │
              ▼
T2.1 ──┬──▶ T2.3 ──▶ T3.1 ──┬──▶ T3.2 (单词结果)
T2.2 ──┘                    │
                            └──▶ T3.3 ──▶ T3.4 (句子结果+词汇点击)
                            │
                            ▼
                    T3.5, T3.6 (并行)
                            │
                            ▼
                    T4.2 ──▶ T4.3 ──▶ T5.1 ──▶ T5.2 ──▶ T5.3
```

## Estimated Effort

| Phase | Tasks | Effort |
|-------|-------|--------|
| Phase 1 | 2 | 1h |
| Phase 2 | 3 | 2h |
| Phase 3 | 6 | 3h |
| Phase 4 | 3 | 1.5h |
| Phase 5 | 3 | 1h |
| **Total** | **17** | **8.5h** |

## Validation Criteria

1. 短文本（1-50字符）显示翻译、记忆、复制按钮
2. 段落文本（50-300字符）显示翻译、复制按钮
3. 超长文本（>300字符）不响应
4. 点击翻译按钮显示翻译结果
5. 短文本中英翻译使用有道（快速）
6. 长文本或非中英使用 AI
7. 单词翻译显示音标、词典、发音
8. 句子翻译原文词汇可点击添加记忆
9. 虚词（a, the, is 等）不可点击
10. 记忆、复制功能正常
11. 主题切换样式正确
12. 错误场景有友好提示
